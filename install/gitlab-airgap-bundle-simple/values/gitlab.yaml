## Default values for gitlab.

app: gitlab

replicaCount: 1

strategy:
  type: Recreate

image:
  repository: 866376286331.dkr.ecr.ap-northeast-2.amazonaws.com/gitlab/gitlab-ce
  tag: "17.6.2-ce.0"
  pullPolicy: IfNotPresent
imagePullSecrets:
  - name: registry-local-credential

ports:
  - name: http
    containerPort: 80
    protocol: TCP

service:
  enabled: true
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "80"
    prometheus.io/path: "/gitlab"
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP

ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: 0m
    nginx.ingress.kubernetes.io/backend-protocol: HTTP
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  host: gitlab-dev.secl.samsung.co.kr
  path: /
  servicePort: 80
  tls:
    enabled: true
    secretName: secl.samsung.co.kr-tls

networkPolicy:
  enabled: false

hostAliases:
# - ip: 70.100.100.100
#   hostnames:
#     - devops.cluster.io

readinessProbe:
  enabled: true
  type: httpGet
  httpGet:
    path: /-/readiness
    port: 80
    scheme: HTTP
  initialDelaySeconds: 180
  periodSeconds: 60
  failureThreshold: 3
  timeoutSeconds: 1
  successThreshold: 1

livenessProbe:
  enabled: true
  type: httpGet
  httpGet:
    path: /-/liveness
    port: 80
    scheme: HTTP
  initialDelaySeconds: 180
  periodSeconds: 60
  failureThreshold: 3
  timeoutSeconds: 1
  successThreshold: 1

resources:
  requests:
    cpu: 500m
    memory: 2Gi
  limits:
    cpu: 1
    memory: 3Gi

nodeSelector:
# kubernetes.io/nodetype: app

persistence:
  - name: opt
    mountPath: /var/opt/gitlab
    existingClaim: gitlab-opt-dev
  - name: etc
    mountPath: /etc/gitlab
    existingClaim: gitlab-etc-dev
  - name: log
    mountPath: /var/log/gitlab
    existingClaim: gitlab-log-dev

env:
  open:
    TZ: Asia/Seoul
    EXTERNAL_URL: https://gitlab-dev.secl.samsung.co.kr
    DB_HOST: gitlab-dev-postgres.c8thupqwxcj4.ap-northeast-2.rds.amazonaws.com
    DB_PORT: 5432
    DB_DATABASE: gitlabhq_production
    DB_USERNAME: gitlab
  config:
    GITLAB_OMNIBUS_CONFIG: gitlab_omnibus_config
  secret:
    DB_PASSWORD: GitlabDev123!
# reflector 구현후 (HTTP 모드에서는 불필요)
# addVolumeMounts:
#   - volumeName: secret-tls
#     mountPath: /etc/gitlab/ssl/gitlab-dev.secl.samsung.co.kr.crt
#     subPath: tls.crt
#     secretName: secl.samsung.co.kr-tls
#   - volumeName: secret-tls
#     mountPath: /etc/gitlab/ssl/gitlab-dev.secl.samsung.co.kr.key
#     subPath: tls.key
#     secretName: secl.samsung.co.kr-tls

configMap:
  ## https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template
  gitlab_omnibus_config: |-
    external_url ENV['EXTERNAL_URL'];
    gitlab_rails['time_zone'] = ENV['TZ'];
    ### Nginx settings
    # nginx['enable'] = true;
    # nginx['listen_port'] = 443;
    # nginx['listen_https'] = true;
    # nginx['ssl_certificate'] = "/etc/gitlab/ssl/gitlab-dev.secl.samsung.co.kr.crt";
    # nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/gitlab-dev.secl.samsung.co.kr.key";
    ### GitLab user privileges
    gitlab_rails['gitlab_default_can_create_group'] = false
    # gitlab_rails['gitlab_username_changing_enabled'] = true
    ### Default project feature settings
    gitlab_rails['gitlab_default_projects_features_issues'] = false
    gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
    gitlab_rails['gitlab_default_projects_features_wiki'] = false
    gitlab_rails['gitlab_default_projects_features_snippets'] = false
    gitlab_rails['gitlab_default_projects_features_builds'] = false
    gitlab_rails['gitlab_default_projects_features_container_registry'] = false
    ### Monitoring settings
    gitlab_rails['monitoring_whitelist'] = ['0.0.0.0/0']
    ### Job Artifacts
    gitlab_rails['artifacts_enabled'] = false
    ### Change the initial default admin password and shared runner registration tokens.
    gitlab_rails['initial_root_password'] = 'Passw0rd!'
    ### GitLab database settings
    gitlab_rails['db_host'] = ENV['DB_HOST'];
    gitlab_rails['db_port'] = ENV['DB_PORT'];
    gitlab_rails['db_database'] = ENV['DB_DATABASE'];
    gitlab_rails['db_username'] = ENV['DB_USERNAME'];
    gitlab_rails['db_password'] = ENV['DB_PASSWORD'];
    ### Settings used by GitLab application
    gitlab_rails['registry_enabled'] = false
    ### GitLab PostgreSQL
    postgresql['enable'] = false
    ### GitLab Redis
    # redis['enable'] = true
    ### Users and groups accounts
    manage_accounts['enable'] = true
    ### Prometheus
    prometheus_monitoring['enable'] = false
    ### Grafana Dashboards (removed in 17.x)
    ### Package repository (EE Only)
    gitlab_rails['packages_enabled'] = false
    ### Dependency proxy (EE Only)
    gitlab_rails['dependency_proxy_enabled'] = false
    ### OmniAuth Settings(IDP)
    gitlab_rails['omniauth_enabled'] = false
    ### keycloak
#    gitlab_rails['omniauth_allow_single_sign_on'] = true
#    gitlab_rails['omniauth_sync_email_from_provider'] = 'openid_connect'
#    gitlab_rails['omniauth_sync_profile_from_provider'] = ['openid_connect']
#    gitlab_rails['omniauth_sync_profile_attributes'] = ['email']
#    gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'openid_connect'
#    gitlab_rails['omniauth_block_auto_created_users'] = false
#    gitlab_rails['omniauth_auto_link_ldap_user'] = false
#    gitlab_rails['omniauth_auto_link_saml_user'] = false
#    gitlab_rails['omniauth_auto_link_user'] = ['openid_connect']
#    gitlab_rails['omniauth_external_providers'] = ['openid_connect']
#
#    gitlab_rails['omniauth_providers'] = [
#      {
#        name: "openid_connect",
#        label: "SCP", # optional label for login button, defaults to "Openid Connect"
#        #icon: "<custom_provider_icon>",
#        args: {
#          name: "openid_connect",
#          scope: ["openid","profile","email"],
#          response_type: "code",
#          issuer: "https://keycloak.secl.samsung.co.kr/realms/devops",
#          discovery: true,
#          client_auth_method: "query",
#          uid_field: "preferred_username",
#          send_scope_to_token_endpoint: "false",
#          client_options: {
#            identifier: "gitlab",
#            secret: "UQNsvlKtTRphlHMTg3jXdChghwvEDvon",
#            redirect_uri: "https://gitlab.secl.samsung.co.kr/users/auth/openid_connect/callback"
#          }
#        }
#      }
#    ]
